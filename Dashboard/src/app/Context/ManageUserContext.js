"use client";

import { API, baseURL } from "@/Utils/Utils";
import React, { createContext, useEffect, useReducer, useState } from "react";

const defaultState = {
  token: null,
  userId: null,
};

export const UserContext = createContext();

async function UserSignUp(body) {
  try {
    const response = await API.post(`${baseURL}/auth/signup`, body);
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function UserSignIn(body) {
  try {
    const response = await API.post(`${baseURL}/auth/signin`, body);
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function UPDATEUSER(body) {
  try {
    const response = await API.put(`${baseURL}/Member/UpdateMember`, body);
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function recordActivity(body) {
  try {
    const response = await API.post(`${baseURL}/activity/storeactivity`, body);
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function StoreSessionData(body) {
  try {
    const response = await API.post(`${baseURL}/session/storesessiondata`,body)
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function MemberActivitylog(body) {
  try {
    const response = await API.get(`${baseURL}/activity/getActivityforMember`, { params: { companyId: body.companyId , userId:body.userId } })
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function GetSystemAnnouncement(body) {
  try {
    const response = await API.get(`${baseURL}/SystemAnnouncements/GetSystemAnnouncements`, { params: { companyId: body.companyId } })
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function SENDOTP(body) {
  try {
    const response = await API.post(`${baseURL}/otp/sentOTP`, body)
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function VERIFYOTP(body) {
  try {
    const response = await API.post(`${baseURL}/otp/verifyOTP`, body)
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

async function PasswordUpdate(body) {
  try {
    const response = await API.put(`${baseURL}/profile/updatepassword/`, body)
    return { status: response?.status, data: response?.data };
  } catch (error) {
    return { status: error?.response?.status, data: error?.response?.data };
  }
}

function reducer(state, action) {
  switch (action.type) {
    case "SIGN_IN": {
      const signinState = { ...action.payload };
      if (typeof window !== "undefined") {
        localStorage.setItem("UserData", JSON.stringify(signinState));
        if (signinState.token) {
          document.cookie = `token=${signinState.token}; path=/; SameSite=Lax`;
        }
        if (signinState.userId) {
          document.cookie = `userId=${signinState.userId}; path=/; SameSite=Lax`;
        }
      }
      return signinState;
    }

    case "UPDATE_PROFILE": {
      const updatedState = { ...state, profilepic: action.payload };
      if (typeof window !== "undefined") {
        localStorage.setItem("UserData", JSON.stringify(updatedState));
      }
      return updatedState;
    }

    case "SIGN_OUT": {
      const signoutState = { token: "", userId: "" };
      if (typeof window !== "undefined") {
        localStorage.setItem("UserData", JSON.stringify(signoutState));
        document.cookie =
          "token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax";
        document.cookie =
          "userId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax";
      }
      return signoutState;
    }

    default:
      return state;
  }
}


export const UserProvider = ({ children }) => {
  const [initialStateLoaded, setInitialStateLoaded] = useState(false);
  const [state, Userdispatch] = useReducer(reducer, defaultState);

  useEffect(() => {
    if (typeof window !== "undefined") {
      const saved = localStorage.getItem("UserData");
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          Userdispatch({ type: "SIGN_IN", payload: parsed });
        } catch {
          console.warn("Failed to parse UserData");
        }
      }
      setInitialStateLoaded(true);
    }
  }, []);

  if (!initialStateLoaded) return null;

  return (
    <UserContext.Provider
      value={{
        UserAuthData: state,
        Userdispatch,
        UserSignIn,
        UserSignUp,
        UPDATEUSER,
        recordActivity,
        StoreSessionData,
        MemberActivitylog,
        GetSystemAnnouncement,
        SENDOTP,
        VERIFYOTP,PasswordUpdate
      }}
    >
      {children}
    </UserContext.Provider>
  );
};
